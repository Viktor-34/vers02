<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PPTX → Русский (бесплатно)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    body { display:flex; min-height:100vh; align-items:center; justify-content:center; background:#0b1020; color:#e9eef5; margin:0; }
    .card { width:min(860px, 92vw); background:#121933; border-radius:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:28px; }
    h1 { margin:0 0 10px; font-size:26px; }
    p.sub { margin:0 0 20px; opacity:.75; }
    .drop { border:2px dashed #3a4a8a; border-radius:18px; padding:28px; text-align:center; transition:.2s; background:rgba(255,255,255,.02); }
    .drop.drag { background:rgba(80,120,255,.08); border-color:#6f8df7; }
    .btn { background:#6f8df7; color:#fff; border:none; border-radius:14px; padding:12px 18px; font-weight:600; cursor:pointer; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .row > * { flex:1; }
    .muted { opacity:.7; font-size:14px; }
    progress { width:100%; height:10px; }
    footer { margin-top:18px; opacity:.65; font-size:12px; }
    a { color:#a7b7ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Перевод PPTX на русский</h1>
    <p class="sub">Бесплатно: Google (неоф.) + fallback на LibreTranslate. Ключи не нужны.</p>

    <div id="drop" class="drop">
      <p><strong>Перетащите .pptx сюда</strong> или выберите файл</p>
      <input id="file" type="file" accept=".pptx" style="display:none">
      <button class="btn" id="pick">Выбрать файл</button>
    </div>

    <div style="height:12px"></div>

    <div class="row">
      <label>Исходный язык
        <select id="source">
          <option value="EN" selected>English</option>
          <option value="AUTO">Auto</option>
        </select>
      </label>
      <label>Целевой язык
        <select id="target">
          <option value="RU" selected>Русский</option>
          <option value="UK">Українська</option>
          <option value="KK">Қазақ</option>
        </select>
      </label>
    </div>

    <div style="height:12px"></div>

    <div>
      <button class="btn" id="go" disabled>Перевести</button>
    </div>

    <div id="status" class="muted" style="margin-top:12px"></div>
    <div id="progress" style="display:none; margin-top:8px">
      <progress id="bar" max="100" value="0"></progress>
    </div>

    <footer>
      Диаграммы/SmartArt могут не переводиться. Исходники сохраняйте как бэкап.
    </footer>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const pickBtn = document.getElementById('pick');
    const goBtn = document.getElementById('go');
    const statusEl = document.getElementById('status');
    const bar = document.getElementById('bar');
    const progWrap = document.getElementById('progress');
    const sourceSel = document.getElementById('source');
    const targetSel = document.getElementById('target');

    let file = null;

    function setStatus(text) { statusEl.textContent = text; }

    function onFiles(files) {
      if (!files || !files[0]) return;
      if (!files[0].name.endsWith('.pptx')) { alert('Выберите файл .pptx'); return; }
      file = files[0];
      setStatus('Файл выбран: ' + file.name);
      goBtn.disabled = false;
    }

    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('drag'); }));
    ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('drag'); }));
    drop.addEventListener('drop', e => onFiles(e.dataTransfer.files));
    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => onFiles(fileInput.files));

    goBtn.addEventListener('click', async () => {
      if (!file) return;
      goBtn.disabled = true; setStatus('Загрузка и перевод…'); progWrap.style.display = 'block'; bar.value = 15;
      try {
        const qs = new URLSearchParams({ source: sourceSel.value, target: targetSel.value });
        const res = await fetch('/.netlify/functions/translate?' + qs.toString(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/octet-stream' },
          body: await file.arrayBuffer(),
        });
        bar.value = 60;
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || 'Ошибка при переводе');
        }
        const blob = await res.blob();
        bar.value = 100; setStatus('Готово');
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name.replace(/\.pptx$/i, '') + '_ru.pptx';
        a.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error(e);
        alert('Ошибка: ' + e.message);
        setStatus('Ошибка: ' + e.message);
      } finally {
        goBtn.disabled = false; progWrap.style.display = 'none';
      }
    });
  </script>
</body>
</html>
